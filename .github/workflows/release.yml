name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Wichtig: Schreibrechte für Releases UND Repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Wichtig für Git Operationen

      - name: Update manifest version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Git konfigurieren für den Commit
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Version extrahieren
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Neue Version: $VERSION"
          
          # manifest.json updaten
          jq --arg ver "$VERSION" '.version = $ver' custom_components/faber_skypad/manifest.json > manifest.tmp && mv manifest.tmp custom_components/faber_skypad/manifest.json
          
          # Änderungen committen und pushen
          git add custom_components/faber_skypad/manifest.json
          git commit -m "chore: bump version to $VERSION [skip ci]" || echo "Keine Änderungen zum Committen"
          # Wir pushen auf den Branch, von dem der Tag kam (meist main/master)
          git push origin HEAD:main || echo "Push fehlgeschlagen oder nicht notwendig"

      - name: Zip component directory
        run: |
          cd custom_components/faber_skypad
          zip -r ../../faber_skypad.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: faber_skypad.zip
          generate_release_notes: true
          draft: false
          prerelease: false